\newpage

# (PART\*) Simulation {-}

# Model Calibration

This chapter will introduce the reader to calibration of the simulation when spatial modeling is involved. The directions assume that work is being using a Linux workstation, or Windows workstation with [Windows Subsystem for Linux (WSL)](https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux) installed. Scripts referenced can typically be found in the [PSU-CIDD-MaSim-Support repository](https://github.com/bonilab/PSU-CIDD-MaSim-Support) and prior to running the scripts it will be necessary to add them to the `PATH`.

## Geographic Data

By design the configuration of the simulation is flexible in terms what must be supplied as raster data and what can be supplied as a single value. In general, the following raster files are required to run the model spatially:

- $Beta$: The beta parameter determines, in part, how many additional infections occur as a result of a single infection and ultimately influences the *Pf*PR. These values must be calculated for each country based upon the inputs.
- Population: The model is initialized with the population values supplied in each of the cells in the raster. This file is mandatory when running spatially and can be generated by down sampling the spatial resolution a publicly available source while preserving the population count.
- *Pf*PR~2-10~: While not directly used by the IBM, a raster of the *Pf*PR values is needed as part of the beta raster generation.

The following raster files a may or may not be needed depending upon the configuration and research goals:

- Access to treatment: In the event that access to treatment is variable depending upon the location within the country, it is necessary to supply a raster file defining the percentage of infected individuals that seek / receive treatment.
- Climate or malaria seasonality: If there are multiple seasonal variations to the malaria season in the country, it is necessary to supply a raster file that links the cell to the seasonal equation to be used.
- Political divisions: Since results are recorded in connection to a political district or region, a file is required to supply these values.
- Travel time or friction surface: Depending upon the movement algorithm selected, a travel time or friction surface is needed to ensure that individuals move in a reasonable fashion.

Once all of the GIS data has been acquired it and aligned, it is necessary to convert it to an [Esri ASCII raster format](https://desktop.arcgis.com/en/arcmap/10.3/manage-data/raster-and-images/esri-ascii-raster-format.htm) (`asc` extension) to be loaded into the model. 

### Intitial Population

Typically the simulation is configured to use a constant [crude birth rate](https://databank.worldbank.org/metadataglossary/gender-statistics/series/SP.DYN.CBRT.IN) during execution, which in turn requires that an *initial population raster* be produced. Assuming a reference population of 1,000 individuals, the initial population can be calculated by applying the equation: 

$$p' = \frac{1000}{\left( 1 + \frac{cbr}{1000}\right) ^n}$$

Where $cbr$ is the crude birth rate, $n$ is the number of years prior to calibration year, and $p'$ is the initial population. The cell multiplier can then be calculated as:

$$multiplier = \frac{1000 - p'}{1000}$$

The resulting $multiplier$ can then be applied using the Raster Calculator functionality in geographic information system (GIS) software (e.g., [ArcGIS Pro](https://www.esri.com/en-us/arcgis/products/arcgis-pro/overview), [GRASS GIS](https://grass.osgeo.org/), or [QGIS](https://qgis.org/en/site/)) where it is recommended that the floating point result be rounded up to the nearest integer value (i.e., [Round Up](https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-analyst/round-up.htm) function in ArcGIS Pro) to ensure that cells with a population always maintain a population. Once applied, the results can be validated by applying the equation:

$$projected = population * \left( 1 + \frac{CBR}{1000} \right)^n$$

Where $projected$ is the projected population $n$ years after the initial $population$ size for the given crude birth rate. Depending upon the number of digits used when applying the *multiplier* there may be some difference in the projected population versus the reference population and while Â±1 individual is accepted for large populations, the result can typically be corrected by increasing the number of digits in the $multiplier$. For cells with a small reference population (ex., $<10$) in the focus should be on ensuring that a population remains in the cell since low population cells are subject to high variance in malaria dynamics during model execution.


## Database Preparations 

It is recommended that a new database be created for each country being studied. One of the limiting factors in the design of the database and IBM is that it presumes that the sequence of genotypes in each configuration file is the same. Once a new database has been created, the genotypes need to be loaded via the following command: 

`./MaSim -l -i [CONFIGURATION]`

## Beta Calibration

### Setting Bounds for Beta Alignment

Once the GIS files have been prepared, work can proceed to generation of the beta parameters.

1.	Begin by ensuring that all of the ASC format raster files are aligned correctly using `validateraster`\
  1.1. If they are not, it will be necessary to determine why they are not aligned correctly.\
  1.2. In general, rasters should be aligned to the population and *Pf*PR~2-10~ rasters, based upon which one has the most complete information.

2.	Following alignment, the `generatebins` command should be run to generate the first calibration script to be run on the cluster this will set the bounds for when the betas are likely in relation to the *Pf*PR~2-10~ values for the country.\
  2.1. First, run `generatebins` using the primary configuration file (e.g., `Studies/rwa-configuration.yml`).\
  2.2. Login to the cluster and create a directory do the calibration from (e.g., `rwa-calibration`).\
  2.3. Copy the following files to the cluster via `sftp` into the previously created directory:
    - From the country repository (e.g., PSU-CIDD-Rwanda):
      - `Studies/out/calibration.sh`
      - `Studies/Calibration/rwa-calibration.yml`
    - From the support repository:
      - `bash/calibrationLib.sh`
      - `bash/manage.sh`
      - `bash/runCalibration.job`
      - `bash/template.job`
      - `bash/population.asc`
      - `bash/zone.asc`

  2.4. Being the control script via the following command: `qsub runCalibration.job`\
  2.5. During calibration be sure to monitor for any errors, in general if replicate files are not deleted by the management script the error log should be checked.

3. Once all of the replicates have been run by `runCalibration.job` run the `createbetamap` command to load the calibration data from the database and create the first beta map.  

### Refining Beta Alignment

Once the bounds have been found it is necessary to reduce the epsilon values to an acceptable margin of error compared to the reference data. The is done by the iterating on the beta values using the `reduceepsilons` script until the sub-national annual rates approximate reference values.

1.	Run the `createbetamap` command and note the maximum epsilon value output.\
   1.1.	If the value is outside of acceptable bounds, run the `reduceEpsilons` command using the maximum epsilon rounded down (e.g., if the maximum is 0.0314 then start with 0.01) and the same decimal place for the step value (i.e., 0.01 per the previous example).\
    1.2. The script will generate `out/reduction.csv` and `out/script.sh` which needs to be uploaded to the cluster.\
    1.3. Once the files have been uploaded run the job on the compute cluster.

2.	Once all of the replicates have run on the cluster, run the `createbetamap` script.\
    2.1. Note the maximum epsilon.\
    2.2. Examine the map of epsilon values (`out/epsilons_beta.asc`) and note the distribution of high epsilon values.\
    2.3. If they correspond to higher population areas repeat Step 1\
    2.4. If they are concentrated largely in low population areas proceed to Step 3.

3.	As the epsilon values are reduced, they need to be checked against the reference values by performing a validation run.\
  3.1. Using the beta map generated and the status quo parameters for the country, run the model at scale.
